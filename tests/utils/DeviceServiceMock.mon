package com.apama.cumulocity.devices;

using com.apama.cumulocity.TenantDetails;
using com.softwareag.connectivity.Chain;
using com.apama.util.Base64;

event DeviceMessage
{
	string transportID;
	string clientID;
	string topic;
	dictionary<string, any> transportProperties;
	any payloadBase64;
}

event DeviceConsumer
{
	action getSubscribeChannel() returns string
	{
		return "devicesubscribechannel"+i;
	}
	integer i;
}

event DevicePublisher
{
	action getSendChannel() returns string
	{
		return "devicesendchannel";
	}
}

event DeviceService
{
	static action connectConsumers(string tenantId, string transport) returns sequence<DeviceConsumer>
	{
		return [DeviceConsumer(0), DeviceConsumer(1), DeviceConsumer(2)];
	}
	static action connectPublisher(string tenantId, string transport) returns DevicePublisher
	{
		return new DevicePublisher;
	}
}

monitor DeviceServiceTestReceiver
{
	action onload()
	{
		monitor.subscribe("devicesendchannel");
		on all DeviceMessage() as dm {
			log "Received device message: " + dm + " decoded payload: "+Base64.base64ToString(<string>dm.payloadBase64);
		}
	}
}
